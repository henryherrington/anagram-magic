<!DOCTYPE html>
<html>
  <head>
    <title>Anagram Magic</title>
    <link rel="stylesheet" type="text/css" href="css/index.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Delius+Unicase:wght@400;700&display=swap" rel="stylesheet">
</head>
  <body>
    <div id="container">
        <p id="title">Anagram Magic</p>
        <div id="gameblock">
            <div id="lobby">
                <h1>Lobby</h1>
                <ul id="players-list"></ul>
                <form id="username-form" action="">
                    <input id="username-input" autocomplete="off" placeholder="username"/><button>Set</button>
                </form>
                <button onclick="enqueuePlayer()">Play</button>
            </div>
            <div id="gameroom">
                <p>Room: <span id="room-name"></span></p>
                <p>Timer: <span id="timer"></span></p>
                <p><span class="player-username"></span>'s Word: <span id="player-word"></span></p>
                <p><span class="opp-username"></span>'s Word: <span id="opp-word"></span></p>
                <form id="word-form" action="">
                    <input id="word-input" autocomplete="off"/><button>Submit</button>
                </form>
                <button onclick="forfeitGame()">Forfeit Game</button>
            </div>
            <div id="end-screen">
                <h1>Game Over</h1>
                <p><span class="player-username"></span></p>
                <p><span class="opp-username"></span></p>
                <br>
                <p><span class="winner-slogan"></span></p>
                <button onclick="returnToLobby()">Lobby</button>
            </div>
        </div>
    </div>
    <script>
        var playersList = document.getElementById("players-list")
        var lobby = document.getElementById("lobby")
        var gameroom = document.getElementById("gameroom")
        var endScreen = document.getElementById("end-screen")
        var roomName = document.getElementById("room-name")
        var timer = document.getElementById("timer")

        function showLobby() {
            lobby.style.display = "block"
            gameroom.style.display = "none"
            endScreen.style.display = "none"
        }

        function showRoom(room) {
            lobby.style.display = "none"
            gameroom.style.display = "block"
            endScreen.style.display = "none"
            roomName.innerHTML = room
        }

        function showEndScreen() {
            lobby.style.display = "none"
            gameroom.style.display = "none"
            endScreen.style.display = "block"
        }

        function startTimer(time) {
            timer.innerHTML = time--;
            var interval = setInterval(function() { 
                if (time >= 0) timer.innerHTML = time--;
                else clearInterval(interval);
            }, 1000);
        }

        function updateUsernames(roomData) {
            let playerUsername = "You"
            let oppUsername = "Your opponent"
            for (let i = 0; i < roomData["players"].length; i++) {
                if (roomData["players"][i] == socket.id) playerUsername = roomData[roomData["players"][i]]["username"]
                else oppUsername = roomData[roomData["players"][i]]["username"]
            }

            playerUsernameElems = document.getElementsByClassName("player-username")
            oppUsernameElems = document.getElementsByClassName("opp-username")
            for (let i = 0; i < playerUsernameElems.length; i++) {
                playerUsernameElems[i].innerHTML = playerUsername
            }
            for (let i = 0; i < oppUsernameElems.length; i++) {
                oppUsernameElems[i].innerHTML = oppUsername
            }
        }

        function updateWinner(roomData) {
            let winners = roomData["winners"]
            let slogan = "It's a tie!"
            if (winners.length == 1) slogan = winners[0] + " wins!"
            winnerUsernameElems = document.getElementsByClassName("winner-slogan")
            for (let i = 0; i < winnerUsernameElems.length; i++) {
                winnerUsernameElems[i].innerHTML = slogan
            }
        }

        function updateWords(roomData) {
            console.log(roomData)
            var playerWord = document.getElementById("player-word")
            var oppWord = document.getElementById("opp-word")
            let players = roomData["players"]

            for (let i = 0; i < players.length; i++) {
                if (players[i] == socket.id) {
                    playerWord.innerHTML = roomData[players[i]]["word"]
                }
                else {
                    oppWord.innerHTML = roomData[players[i]]["word"]
                }
            }
        }

    </script>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io()

        function enqueuePlayer() {
            socket.emit("enqueue player")
        }

        function forfeitGame() {
            socket.emit("forfeit game")
        }
        
        function returnToLobby() {
            showLobby()
            socket.emit("terminate room")
        }

        // username form
        var usernameForm = document.getElementById("username-form")
        var usernameInput = document.getElementById("username-input")
        usernameForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (usernameInput.value) {
                socket.emit('username', usernameInput.value);
                usernameInput.value = '';
            }
        })

        //word form
        var wordForm = document.getElementById("word-form")
        var wordInput = document.getElementById("word-input")
        wordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (wordInput.value) {
                socket.emit('word', wordInput.value);
                wordInput.value = '';
            }
        })

        socket.on('lobby players', function(usernames) {
            playersList.innerHTML = '';
            for (const [socketId, username] of Object.entries(usernames)) {
                var item = document.createElement('li');
                item.textContent = username;
                playersList.appendChild(item);
            }
        })

        socket.on('in room', function(room, roomData, timer) {
            showRoom(room)
            updateUsernames(roomData)
            startTimer(timer)
        })

        socket.on('update game', function(roomData) {
            updateWords(roomData)
        })

        socket.on("end game", function(roomData) {
            console.log(roomData)
            showEndScreen()
            updateUsernames(roomData)
            updateWinner(roomData)
        })

    </script>
  </body>
</html>